# 服务器挖矿程序清理与加固指南

阿里云检测到挖矿程序，需在服务器上立即处理。

---

## 一、告警信息摘要

| 告警名称   | 路径                                   | 时间               |
|------------|----------------------------------------|--------------------|
| 挖矿程序   | /tmp/init                              | 2026-01-31 00:46:08 |
| 挖矿程序   | /tmp/mysql                             | 2026-01-31 00:46:08 |
| 挖矿程序   | /proc/209165/root/tmp/mysql            | 2026-01-30 23:38:16 |
| 挖矿程序   | /proc/1469/root/tmp/mysql              | 2026-01-26 20:48:13 |

受影响 IP：`8.138.110.247`（公网）、`172.18.58.2`（内网）

> **说明**：`/tmp/mysql`、`/tmp/init` 是常见伪装名，真实 MySQL 不会放在 `/tmp`。  
> `/proc/XXX/root/tmp/` 表示某进程根目录下的 `/tmp`，可能来自容器或进程隔离环境。

---

## 二、立即在服务器上执行

### 1. SSH 登录服务器

```bash
ssh root@8.138.110.247
# 或使用你的登录方式
```

### 2. 删除告警中的可疑文件

```bash
# 删除告警路径
sudo rm -f /tmp/init /tmp/mysql

# 检查是否还有同名文件
ls -la /tmp/init /tmp/mysql 2>/dev/null || echo "已清理"
```

### 3. 检查并终止相关进程

```bash
# 查看告警中的 PID 是否仍在运行（209165、1469）
ps aux | grep -E "209165|1469"

# 若存在则终止（替换 PID 为实际进程号）
# sudo kill -9 209165 1469
```

### 4. 如使用 Docker，检查容器内

```bash
# 列出运行中的容器
docker ps

# 检查容器内 /tmp 是否有 mysql、init
docker exec lego_price_king_app ls -la /tmp/
docker exec lego_price_king_db ls -la /tmp/

# 若发现可疑文件则删除
# docker exec <容器名> rm -f /tmp/mysql /tmp/init
```

### 5. 查找高 CPU 占用进程（挖矿常见特征）

```bash
top -b -n 1 | head -20
# 或
ps aux --sort=-%cpu | head -15
```

如有不明进程长时间占用高 CPU，可记下 PID 并终止：

```bash
sudo kill -9 <PID>
```

### 6. 检查定时任务是否被篡改

```bash
crontab -l
sudo cat /etc/crontab
ls -la /etc/cron.d/
```

若发现不明定时任务（尤其执行 `/tmp/` 下脚本），删除对应行。

---

## 三、使用项目提供的清理脚本（可选）

在项目目录执行：

```bash
cd /opt/lego-price-king   # 或你的部署目录
chmod +x scripts/cleanup-mining-malware.sh
sudo ./scripts/cleanup-mining-malware.sh
```

脚本会删除告警文件、扫描 `/tmp` 可疑程序、检查 Docker 容器、列出高 CPU 进程。

---

## 四、PostgreSQL 漏洞风险处理

阿里云还报告「PostgreSQL 漏洞风险」，建议：

1. **限制 PostgreSQL 公网访问**
   - 若仅在 Docker 内网使用，确保 `docker-compose.yml` 中 `ports: "5432:5432"` 仅绑定内网，或通过安全组限制 5432 仅内网可访问。
   - 检查安全组：5432 端口不要对 `0.0.0.0/0` 开放。

2. **更新 PostgreSQL 镜像**

```bash
cd /opt/lego-price-king
docker compose pull postgres
docker compose up -d --force-recreate postgres
```

3. **强密码**  
   确认 `POSTGRES_PASSWORD` 足够复杂，不要使用 `postgres` 等弱密码。

---

## 五、加固建议

| 项目           | 建议                                      |
|----------------|-------------------------------------------|
| SSH            | 禁用 root 密码登录，使用密钥；可考虑改端口 |
| 防火墙/安全组  | 仅开放 80/443、SSH 等必要端口             |
| 数据库         | PostgreSQL 不对外网开放 5432              |
| 定期检查       | 定期查看 `top`、`/tmp`、crontab           |
| 阿里云         | 开通云盾、定期查看安全告警                 |

---

## 六、清理后操作

1. 在阿里云控制台对当前告警执行 **批量解封**（若 IP 已被封禁）。
2. 重启服务器后，再次检查是否仍有告警。
3. 观察数日，确认无新告警、CPU 正常。

如清理后仍频繁出现挖矿告警，建议考虑重装系统并重新部署，并加强上述加固措施。
