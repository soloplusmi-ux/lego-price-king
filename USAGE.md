# 使用指南

## 数据同步脚本使用

### Excel 文件格式

Excel 文件应包含以下列（列名可以是中文或英文）：

**必需列**:
- `setNumber` 或 `编号` - 乐高套装编号（如: 10294）
- `name` 或 `名称` - 套装名称
- `theme` 或 `主题` - 主题名称
- `year` 或 `年份` - 发布年份

**可选列**:
- `subTheme` 或 `子主题` - 子主题
- `minifigs` 或 `人仔数` - 人仔数量
- `imageUrl` 或 `图片链接` - 如果已有图片链接，可以不提供图片文件
- `lastPrice` 或 `最近价格` - 初始价格

**示例 Excel 数据**:

| 编号 | 名称 | 主题 | 年份 | 子主题 | 人仔数 |
|------|------|------|------|--------|--------|
| 10294 | 泰坦尼克号 | Ideas | 2021 | - | 0 |
| 75192 | 千年隼 | Star Wars | 2017 | Ultimate Collector Series | 0 |

### 图片文件命名

图片文件应放在 `data/images/` 目录下，命名格式：

- `{setNumber}.jpg` - 例如: `10294.jpg`
- `{setNumber}.png` - 例如: `10294.png`
- `{setNumber}.webp` - 例如: `10294.webp`

脚本会自动查找匹配的图片文件。

### 运行同步脚本

```bash
# 1. 确保数据文件已准备好
#    - data/excel/lego_sets.xlsx
#    - data/images/*.jpg (或 .png, .webp)

# 2. 确保 .env 文件已配置远程数据库连接
#    REMOTE_DATABASE_URL="postgresql://..."

# 3. 安装脚本依赖（首次运行）
cd scripts
npm install

# 4. 运行同步脚本
cd ..
node scripts/sync_data.js
```

### 同步脚本输出

脚本会显示：
- 读取的记录数
- 每一条记录的同步状态
- 图片上传进度
- 最终同步结果

**示例输出**:
```
🚀 开始同步数据...

读取到 50 条记录

处理批次 1/1
[1/50] 上传图片: 10294
[1/50] ✓ 同步成功: 10294 - 泰坦尼克号
[2/50] ✓ 同步成功: 75192 - 千年隼
...

✅ 数据同步完成！
```

## 网站使用

### 搜索功能

1. 在首页搜索框输入：
   - 套装编号（如: 10294）
   - 套装名称（如: 泰坦尼克号）
   - 主题名称（如: Ideas）

2. 点击"搜索"按钮或按 Enter

3. 查看搜索结果列表

### 查看套装详情

1. 在搜索结果中点击任意套装卡片

2. 查看详细信息：
   - 基本信息（编号、主题、年份等）
   - 价格历史图表
   - 购买渠道列表

### 更新价格

1. 在套装详情页，点击"更新价格"按钮

2. 系统会：
   - 从淘宝联盟 API 获取最新价格
   - 计算中位数价格（去除最高5个和最低5个）
   - 更新价格历史
   - 刷新店铺列表

3. 页面会自动刷新显示最新数据

## API 使用

### 价格刷新 API

**端点**: `POST /api/refresh-prices`

**认证**: 需要在请求中包含 API 密钥

**方式 1: Query 参数**
```
POST /api/refresh-prices?setNumber=10294&key=your-api-secret-key
```

**方式 2: Header**
```
POST /api/refresh-prices?setNumber=10294
Authorization: Bearer your-api-secret-key
```

**方式 3: X-API-Key Header**
```
POST /api/refresh-prices?setNumber=10294
X-API-Key: your-api-secret-key
```

**响应示例**:
```json
{
  "success": true,
  "medianPrice": 299.50,
  "stores": [
    {
      "shopName": "店铺名称",
      "price": 299.50,
      "affiliateLink": "https://..."
    }
  ],
  "message": "价格更新成功"
}
```

**错误响应**:
```json
{
  "error": "错误信息"
}
```

## 数据管理

### 添加新套装

1. 在 Excel 文件中添加新行
2. 准备对应的图片文件
3. 运行同步脚本

### 更新现有套装

1. 修改 Excel 文件中的对应行
2. 如果需要更新图片，替换 `data/images/` 中的图片文件
3. 运行同步脚本（脚本会自动更新）

### 批量导入

同步脚本支持批量处理，可以一次性导入数百条记录。脚本会自动：
- 分批处理（每批 50 条）
- 处理错误（单条失败不影响其他记录）
- 显示进度

## 最佳实践

1. **定期备份数据库**: 使用 `pg_dump` 定期备份
2. **监控日志**: 定期查看应用和数据库日志
3. **更新价格**: 定期使用"更新价格"功能保持数据最新
4. **数据验证**: 同步前检查 Excel 数据完整性
5. **图片优化**: 建议使用压缩后的图片（JPG/WebP）以减少上传时间

## 故障排除

### 同步脚本报错

**问题**: "请配置 DATABASE_URL 或 REMOTE_DATABASE_URL"
- **解决**: 检查 `.env` 文件中的数据库配置

**问题**: "上传图片失败"
- **解决**: 检查阿里云 OSS 配置和网络连接

**问题**: "处理第 X 条记录时出错"
- **解决**: 检查 Excel 数据格式，确保必填字段完整

### 网站无法访问

**问题**: 页面显示错误
- **解决**: 检查服务器日志 `docker-compose logs app`

**问题**: 搜索无结果
- **解决**: 确认数据已成功同步到数据库

**问题**: 价格更新失败
- **解决**: 检查淘宝联盟 API 配置和 API 密钥
