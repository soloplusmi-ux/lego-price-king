#!/bin/bash
# 挖矿程序清理脚本 - 在阿里云服务器上执行
# 用法：chmod +x cleanup-mining-malware.sh && sudo ./cleanup-mining-malware.sh

set -e

echo "=========================================="
echo "  挖矿程序清理脚本 (乐高比价王服务器)"
echo "=========================================="
echo ""

# 1. 删除阿里云告警中的可疑文件
echo "[1/6] 删除告警路径中的可疑文件..."
PATHS=("/tmp/init" "/tmp/mysql")
for p in "${PATHS[@]}"; do
  if [ -f "$p" ] || [ -x "$p" ]; then
    echo "  发现并删除: $p"
    rm -f "$p"
  else
    echo "  未找到: $p (可能已被删除或为进程内路径)"
  fi
done

# 2. 检查 /tmp 下可疑可执行文件（常见挖矿伪装名）
echo ""
echo "[2/6] 扫描 /tmp 下可疑可执行文件..."
find /tmp -type f -executable 2>/dev/null | while read f; do
  case "$(basename "$f")" in
    init|mysql|redis|kdevtmpfsi|kinsing|xmrig|minerd)
      echo "  发现可疑文件: $f"
      file "$f" 2>/dev/null || true
      rm -f "$f" && echo "    已删除" || echo "    删除失败(可能需root)"
      ;;
  esac
done

# 3. 检查 /proc 中相关进程（阿里云告警中的 PID 209165, 1469）
echo ""
echo "[3/6] 检查告警相关进程..."
for pid in 209165 1469; do
  if [ -d "/proc/$pid" ]; then
    echo "  进程 $pid 仍在运行:"
    ps -p $pid -o pid,user,cmd 2>/dev/null || true
    kill -9 $pid 2>/dev/null && echo "    已终止" || echo "    无法终止(需root: sudo kill -9 $pid)"
  else
    echo "  进程 $pid 已不存在"
  fi
done

# 4. 检查 Docker 容器内是否有 /tmp/mysql 等
echo ""
echo "[4/6] 检查 Docker 容器内可疑文件..."
if command -v docker &>/dev/null; then
  for cid in $(docker ps -q 2>/dev/null); do
    if docker exec "$cid" test -f /tmp/mysql 2>/dev/null || docker exec "$cid" test -f /tmp/init 2>/dev/null; then
      echo "  容器 $cid 内发现可疑文件:"
      docker exec "$cid" ls -la /tmp/mysql /tmp/init 2>/dev/null || true
      docker exec "$cid" rm -f /tmp/mysql /tmp/init 2>/dev/null
      echo "    已删除容器内文件"
    fi
  done
else
  echo "  未安装 docker，跳过"
fi

# 5. 查找高 CPU 进程（挖矿典型特征）
echo ""
echo "[5/6] 检查高 CPU 占用进程（前 10）..."
ps aux --sort=-%cpu | head -12

# 6. 建议操作
echo ""
echo "[6/6] 建议后续操作:"
echo "  - 修改 SSH 端口，禁用 root 密码登录，仅用密钥"
echo "  - 检查 crontab: crontab -l 与 cat /etc/crontab"
echo "  - 检查 PostgreSQL 是否暴露公网，必要时仅监听内网"
echo "  - 阿里云控制台: 批量解封 后，加强安全组规则"
echo ""
echo "=========================================="
echo "  清理完成。请重启服务器后再次确认无告警。"
echo "=========================================="
