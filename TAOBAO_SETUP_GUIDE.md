# 淘宝联盟 API 接入分步指南

按下面顺序操作，即可在乐高比价王里用**真实淘宝价格和店铺**驱动「更新价格」和「购买渠道」。

---

## 第一步：在淘宝联盟完成推广者与推广位

### 1.1 打开淘宝联盟并登录

1. 浏览器打开：**https://pub.alimama.com/**
2. 用你的**淘宝账号**登录（未有则先注册淘宝）。

### 1.2 成为「推广者」

1. 登录后若提示「申请推广者」或「完善信息」，按页面的**推广者**流程完成（通常需绑定支付宝、实名等）。
2. 若已是推广者，可直接进入后台。

### 1.3 新建推广位并拿到 adzone_id

1. 在联盟后台左侧进入：**推广管理** → **推广位管理**。
2. 点击 **新建推广位**（或「新增」）。
3. 按提示填写：
   - **推广位名称**：例如「乐高比价王」
   - **推广位类型**：选 **网站**（若你的站点是网站）
   - 如要求填**备案域名/网站信息**，填你实际部署乐高比价王的域名（或备案中的域名）；若暂无，先按可填的临时信息完成，后续在联盟里可改。
4. 保存后，在推广位列表里找到刚建的推广位，会看到 **PID**，形如：
   ```text
   mm_12345678_222333_444555666
   ```
5. **adzone_id** 就是 PID 的**最后一段数字**，例如上面里的 `444555666`。  
   **记下这个数字**，后面 `.env` 里的 `TAOBAO_ADZONE_ID` 就填它。

---

## 第二步：在淘宝开放平台创建应用并拿到 App Key、App Secret

### 2.1 打开开放平台并登录

1. 打开：**https://open.taobao.com/**
2. 用**淘宝账号**登录（可与联盟同一账号）。

### 2.2 创建应用

1. 进入 **控制台**（或「开发者中心」）。
2. 选择 **创建应用**（或「添加应用」）。
3. **应用类型** 选 **网站应用**（与你在联盟里选的「网站」一致；若你选的是其它类型，这里需对应）。
4. 填写：
   - **应用名称**：如「乐高比价王」
   - **应用简介**：简短说明用途，如「乐高套装比价与推广」
   - **应用网址**：你站点首页地址，例如 `https://你的域名/`
   - **回调地址**：淘宝客物料接口如不需要 OAuth 回调，可先填应用网址或按提示填
5. 提交后等待审核（通常 1–3 个工作日，具体以页面为准）。

### 2.3 添加「淘宝客」API 权限

1. 在控制台找到刚创建的应用，点进 **应用详情**。
2. 在 **API 权限** 或 **接口管理** 里，找到并勾选以下与淘宝客相关的接口（名称可能略有差异，以控制台为准）：
   - **淘宝客-推广者-物料搜索**（或 `taobao.tbk.dg.material.optional`）
   - 若有 **转链接 / 权益 / 高佣** 等淘宝客相关接口，也可一并申请，便于后续扩展。
3. 保存/提交，如需二次审核则按提示等待。

### 2.4 获取 App Key 和 App Secret

1. 在应用的 **应用详情** 或 **密钥管理** 里，会看到：
   - **App Key**（即 `app_key`）
   - **App Secret**（即 `app_secret`，可能需点击「查看」或短信验证后显示）
2. **把 App Key 和 App Secret 复制保存到本地**（不要泄露、不要提交到 Git）。  
   后面 `.env` 中：
   - `TAOBAO_APP_KEY` = 这个 App Key  
   - `TAOBAO_APP_SECRET` = 这个 App Secret  

---

## 第三步：在项目里配置 .env

### 3.1 找到 .env 文件

- 在项目根目录（与 `package.json` 同级）找到 **`.env`**。  
- 若没有，可复制 **`.env.example`** 为 **`.env`**，再编辑。

### 3.2 填写淘宝联盟三行

在 `.env` 中找到或新增下面三行，把占位替换成你在第一、二步拿到的真实值：

```env
TAOBAO_APP_KEY="你的 App Key（来自开放平台）"
TAOBAO_APP_SECRET="你的 App Secret（来自开放平台）"
TAOBAO_ADZONE_ID="你的 adzone_id（来自联盟推广位 PID 最后一段）"
```

**示例**（仅作格式参考，务必换成你自己的）：

```env
TAOBAO_APP_KEY="12345678"
TAOBAO_APP_SECRET="abcdef1234567890abcdef1234567890"
TAOBAO_ADZONE_ID="444555666"
```

注意：

- 值建议用**英文双引号**包起来，尤其是含特殊字符时。
- 等号两边**不要加空格**。
- **不要**把 `.env` 提交到 Git；`.gitignore` 中应包含 `.env`。

### 3.3 服务器上的 .env

- 若应用部署在**服务器**（如 `/opt/lego-price-king`），需要在**服务器上的项目根目录**编辑同一份 `.env`，填入相同的三行。  
- 修改后需**重启应用**（例如 `docker compose up -d` 或重启 Node 进程），新的环境变量才会生效。

---

## 第四步：确认代码已接入淘宝客 API

项目中的 **`app/api/refresh-prices/route.ts`** 已实现：当 `TAOBAO_APP_KEY`、`TAOBAO_APP_SECRET`、`TAOBAO_ADZONE_ID` 均已配置时，会调用淘宝客 **物料搜索** 接口 `taobao.tbk.dg.material.optional`，用「乐高 + 套装编号/名称」搜索商品，解析出**价格、店铺名、推广链接**，并返回给「更新价格」和「购买渠道」使用。

你只需保证：

1. 上述三个环境变量在 **`.env`** 中已正确填写并生效（本地或服务器，根据你运行环境）。  
2. 若你拉取的代码尚未包含该实现，请从本仓库获取最新 `app/api/refresh-prices/route.ts`。

无需再改 `.env` 的 key 名；变量名必须为：  
`TAOBAO_APP_KEY`、`TAOBAO_APP_SECRET`、`TAOBAO_ADZONE_ID`。

---

## 第五步：重启应用并验证

### 5.1 本地开发

若在本地用 `npm run dev`：

1. 确认 `.env` 已保存。
2. 停止当前 dev（Ctrl+C），再执行：
   ```bash
   npm run dev
   ```

### 5.2 服务器 Docker

若用 Docker 部署：

1. 确认服务器上项目根目录的 `.env` 已含有上述三行。
2. 在项目目录执行，例如：
   ```bash
   cd /opt/lego-price-king
   docker compose up -d
   ```
   或  
   ```bash
   docker-compose up -d
   ```

### 5.3 验证是否走真实 API

1. 打开任意乐高套装详情页，点击 **「更新价格」**。  
2. 若配置正确且接口正常：
   - **淘宝信价中位数** 会变成来自淘宝接口的**真实价格**（或基于真实商品算出的中位数）；  
   - **购买渠道 (Top 15)** 会列出**真实店铺名**，且「购买」跳转到**带你 PID 的淘宝/天猫商品页或券页**。  
3. 若仍为「示例店铺」或出现 **「⚠ 当前为模拟数据。xxx」**，说明还在走**模拟逻辑**，请按下面「排查」逐项检查。

---

## 排查：仍是示例数据或报错时的自检

点击「更新价格」后，若出现 **「⚠ 当前为模拟数据。xxx」**，后面的 `xxx` 即回退原因，可按之排查：

| 提示内容 | 处理 |
|----------|------|
| `TAOBAO_APP_KEY、TAOBAO_APP_SECRET、TAOBAO_ADZONE_ID 未配置或为空` | 在**服务器** `/opt/lego-price-king/.env` 中补全三项，然后 `docker compose up -d` 重启。 |
| `淘宝接口返回错误: 11`、`scope ids is ...` | **API 权限/scope 不足**。在开放平台为应用勾选并申请 **淘宝客-推广者-物料搜索**，等审核通过后再试。见下「错误 11 与 scope ids」。 |
| `淘宝接口返回错误: 27` 等 | 开放平台应用未审核、未勾选物料搜索，或 adzone/备案有问题，见下 2、3。 |
| `淘宝接口返回空结果` | 该套装在淘宝几乎无商品，或可换一个热门编号试；接口本身已正常。 |
| `请求异常: xxx` | 网络或域名解析问题，可查 `docker compose logs app --tail 50` 是否有 `[淘宝价格] 回退模拟数据`。 |

### 1. 环境变量未生效

- **本地**：确认改的是**项目根目录**的 `.env`，且重启了 `npm run dev`。  
- **Docker**：确认 `docker-compose.yml` 里 app 使用了 `env_file: .env` 或 `environment` 传入了这三项；然后执行 `docker compose up -d` 或 `docker-compose restart app`。

可在容器内验证（仅作调试，注意不要泄露 Secret）：

```bash
docker exec lego_price_king_app printenv | grep TAOBAO
```

应能看到 `TAOBAO_APP_KEY`、`TAOBAO_APP_SECRET`、`TAOBAO_ADZONE_ID` 且非空。

### 2. 淘宝开放平台应用未审核通过或未勾选 API

- 在开放平台 **控制台 → 应用详情** 查看应用状态，须为 **已上线/已通过**。  
- 在 **API 权限** 里确认已勾选 **淘宝客-推广者-物料搜索**（或 `taobao.tbk.dg.material.optional`）并已生效。

**错误 11 与 scope ids**  

- **错误 11**：淘宝 API 的错误码，表示「权限/scope 不足」或「接口对该应用不可用」。  
- **scope ids is 381 11680 11687 11741 11773 16516**：这是淘宝返回的 `sub_msg`，列出的是**本次接口校验时涉及的权限包 ID**（381=系统工具、11680=初级电商、11687=云账号、11741=百川网关、11773=百川基础、**16516=淘宝客【推广者】物料搜索**）。不是说「你缺 11 这个 id」——**11 是错误码，不是权限包 ID**。

若你在控制台看到 **淘宝客【推广者】物料搜索（16516）已获得**，却仍报 11，多半是下面之一：

1. **App Key 与「已获得 16516」的应用不是同一个**  
   你可能有多个应用。`.env` 里的 `TAOBAO_APP_KEY` 必须等于**展示「淘宝客【推广者】物料搜索 16516 已获得」的那一个应用**的 App Key。到 **开放平台 → 控制台** 点进该应用 → **应用详情/密钥**，对照 App Key 是否与 `.env` 完全一致。

2. **应用未上线**  
   该应用状态须为 **已上线** 或 **已通过**。若为「开发中」「审核中」，物料接口可能仍返回 11。

3. **权限刚通过、未生效**  
   审核通过后可能有几小时延迟，可第二天再试。

4. **`sub_code: isv.permission-api-package-limit`（权限包限制）**  
   若 `error_response` 中 `sub_code` 为 `isv.permission-api-package-limit`，表示**即使权限包已获得，但关联的包中不允许访问该 API**。根据淘宝开放平台文档，这表示需要**根据业务规则申请对应的权限**。可能原因：
   
   **a) 应用类型与 API 不匹配（最常见）**  
   - 物料搜索接口 `taobao.tbk.dg.material.optional` 可能要求应用类型为**「网站应用」**或**「淘宝客应用」**，且备案类型为**「网站」**、**「自有平台」**或**「其他平台」**（如微博、微信等）。
   - 若你的应用是「联盟通用应用」或备案为「无自有阵地」，可能不在该接口允许的应用类型范围内。
   - **排查步骤**：
     1. 登录开放平台 → 控制台 → 应用详情，查看**应用类型**和**应用标签**。
     2. 若应用类型不是「网站应用」，考虑创建一个新的**「网站应用」**，并在该应用下申请 16516 权限。
     3. 若备案类型为「无自有阵地」，可尝试在联盟后台将备案类型改为：
        - **「网站」**（需有实际网站域名）
        - **「自有平台」**（需有自有平台信息）
        - **「其他平台」**（如微博、微信等，需填写对应平台信息）
     4. **备案类型变更后**，可能需要等待几小时到一天时间让变更生效，然后再测试 API 调用。
   
   **b) 权限包与 API 的关联关系未生效**  
   - 16516 已获得，但系统校验时认为该权限包与 `taobao.tbk.dg.material.optional` 的关联未生效。
   - **排查步骤**：
     1. 在开放平台该应用的**API 权限**里，**重新勾选并保存**「淘宝客-推广者-物料搜索 (16516)」。
     2. 等待几小时或第二天再试（权限关联可能有延迟）。
   
   **c) 推广位与应用的归属不匹配**  
   - 确认 `TAOBAO_ADZONE_ID` 对应的推广位，是否属于与当前 `TAOBAO_APP_KEY` 绑定的媒体/备案。
   - 若推广位属于其他媒体，limit 校验可能失败。
   - **排查步骤**：
     1. 在联盟后台 → 推广位管理，确认推广位 `116228300095` 所属的媒体/备案。
     2. 确认该媒体是否与开放平台应用 `35279634` 关联（或通过「APPKEY申请」绑定）。
   
   **d) 业务规则限制**  
   - 某些接口可能对特定备案类型、应用类型或推广位类型有额外限制。
   - **排查步骤**：
     1. 若持续报 `isv.permission-api-package-limit`，建议联系 [淘宝开放平台-开发者支持](https://open.taobao.com/support/index.htm)。
     2. 提供以下信息：
        - `request_id`（从最新的 `error_response` 里取）
        - `sub_code: isv.permission-api-package-limit`
        - 应用 App Key：`35279634`
        - 权限包 16516 已获得
        - 备案类型：无自有阵地（或你的实际备案类型）
        - adzone_id：`116228300095`
        - 询问：`taobao.tbk.dg.material.optional` 接口对应用类型、备案类型、推广位类型的具体要求
   
   **其他相关权限错误类型**（供参考）：  
   - `isv.permission-api-package-empty`：没有和任何访问包关联
   - `isv.permission-api-package-not-allowed`：不允许访问不可访问组的 API
   - `isv.permission-ip-whitelist-limit`：IP 限制不允许访问
   - `isv.permission-api-widget-only-limit`：仅允许 widget（组件）方式访问

5. **按上面 1～4 自查后仍报 11**  
   可看应用日志里的 `[淘宝价格] error_response:` 完整 JSON，把 `sub_code`、`sub_msg`、`request_id` 等信息提供给 [淘宝开放平台-开发者支持](https://open.taobao.com/support/index.htm) 进一步排查。

### 3. 淘宝联盟推广位或 PID 问题

- 确认 **adzone_id** 来自 **推广位管理** 里对应推广位的 **PID 最后一段**，且该推广位状态正常、未违规。  
- 若联盟要求**备案**或**绑定域名**，需在联盟后台完成，否则物料接口可能返回权限类错误。

### 4. 接口返回错误信息

- 若「更新价格」后提示「未找到价格信息」或 500，可查看应用日志，例如：
  ```bash
  docker compose logs app --tail 100
  ```
- 若日志中有 `sub_code`、`sub_msg` 或 `code`，可把其内容与 [淘宝开放平台-文档中心](https://open.taobao.com/api.htm) 中对应错误码对照；常见如：
  - **权限 / 备案**：回联盟与开放平台补全备案、推广位和域名。  
  - **签名错误**：多为 `app_secret` 或参数顺序、编码问题；确认 `TAOBAO_APP_SECRET` 与开放平台完全一致、无多余空格或换行。  
  - **adzone_id 无效**：核对是否从正确 PID 取最后一段、是否为数字。  

### 5. 搜索无结果

- 当前搜索词为「乐高 + 套装编号」或「乐高 + 套装名称」。若某个套装在淘宝上几乎没有商品，接口可能返回空列表，此时会回退为**模拟数据**（示例店铺 + 淘宝搜索链接）。  
- 可尝试在淘宝/天猫直接搜索「乐高 该套装编号」验证是否有商品。

---

## 小结：你需要拿到的三个值

| 配置项 | 从哪里获取 | 填到 .env 的变量名 |
|--------|------------|--------------------|
| App Key | 淘宝开放平台 → 控制台 → 应用详情 / 密钥 | `TAOBAO_APP_KEY` |
| App Secret | 同上 | `TAOBAO_APP_SECRET` |
| adzone_id | 淘宝联盟 → 推广管理 → 推广位管理 → 新建推广位 → PID 的**最后一段数字** | `TAOBAO_ADZONE_ID` |

把这三项正确填入 **`.env`**，并确保应用**重启后读到**，即可使用真实淘宝价格和店铺；若仍异常，按上述排查步骤检查即可。
