# æ•°æ®åº“æŒä¹…åŒ–è¯´æ˜ï¼š
# - æ•°æ®å·ä½¿ç”¨å›ºå®šåç§° lego_price_king_postgres_dataï¼Œé‡å¯/æ›´æ–°ä»£ç ä¸ä¼šä¸¢æ•°æ®ã€‚
# - ä¸¥ç¦ä½¿ç”¨ docker compose down -vï¼ˆä¼šåˆ é™¤æ•°æ®å·ï¼Œæ•°æ®å°†å…¨éƒ¨ä¸¢å¤±ï¼‰ã€‚
# - æ­£å¸¸æ›´æ–°ï¼šgit pull && docker compose up -d --build å³å¯ï¼Œæ•°æ®ä¼šä¸€ç›´ä¿ç•™ã€‚
services:
  # PostgreSQL æ•°æ®åº“ï¼ˆæ•°æ®æŒä¹…åŒ–åœ¨å›ºå®šå·ä¸­ï¼Œé™¤éæ‰‹åŠ¨åˆ é™¤å·å¦åˆ™ä¸€ç›´ä¿ç•™ï¼‰
  postgres:
    image: postgres:15-alpine
    container_name: lego_price_king_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: lego_price_king
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # åªæ£€æŸ¥ Postgres æ˜¯å¦å°±ç»ªï¼Œä¸ä¾èµ– lego_price_king åº“å­˜åœ¨ï¼ˆåº“ç”± app å¯åŠ¨æ—¶åˆ›å»ºï¼Œé¿å…æ­»é”ï¼‰
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    networks:
      - lego_network
    restart: unless-stopped

  # Next.js åº”ç”¨
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: lego_price_king_app
    environment:
      # ä¸ postgres æœåŠ¡å…±ç”¨ POSTGRES_PASSWORDï¼Œé»˜è®¤ postgres
      # æ³¨æ„ï¼šå¦‚æœ .env ä¸­è®¾ç½®äº† POSTGRES_PASSWORDï¼Œè¿™é‡Œä¼šè‡ªåŠ¨ä½¿ç”¨ï¼›å¦åˆ™ä½¿ç”¨é»˜è®¤å€¼ postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      DATABASE_URL: "postgresql://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/lego_price_king?schema=public&connection_limit=10&pool_timeout=20&connect_timeout=10"
      NODE_ENV: production
      # ä» .env æ–‡ä»¶è¯»å–å…¶ä»–é…ç½®
    env_file:
      - .env
    ports:
      - "3000:3000"
    volumes:
      # æŒ‚è½½ public/imagesï¼Œä¾¿äºåœ¨æœåŠ¡å™¨ä¸Šç›´æ¥æ”¾ç½®ä»¥ã€Œç¼–å·ã€å‘½åçš„å›¾ç‰‡ï¼ˆå¦‚ 10264-1.jpgï¼‰
      - ./public/images:/app/public/images
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - lego_network
    restart: unless-stopped
    # å¯åŠ¨æ—¶å…ˆç­‰å¾…æ•°æ®åº“å°±ç»ªï¼Œåˆ›å»ºåº“ï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰ï¼Œç”Ÿæˆ Prisma Clientï¼Œç„¶åå¯åŠ¨åº”ç”¨
    command: sh -c "echo 'ç­‰å¾…æ•°æ®åº“å°±ç»ª...' && sleep 5 && cd /app && echo 'åˆ›å»º/ç¡®è®¤æ•°æ®åº“ lego_price_king...' && (PGPASSWORD=$${POSTGRES_PASSWORD:-postgres} psql -h postgres -U postgres -d postgres -c \"CREATE DATABASE lego_price_king;\" 2>/dev/null || true) && echo 'âœ… æ•°æ®åº“ lego_price_king å·²ç¡®è®¤å­˜åœ¨' && npx prisma generate --schema=./prisma/schema.prisma && echo 'âœ… Prisma Client ç”Ÿæˆå®Œæˆ' && npx prisma db push --accept-data-loss --skip-generate && echo 'âœ… æ•°æ®åº“è¡¨ç»“æ„å·²åŒæ­¥' && echo 'ğŸš€ å¯åŠ¨åº”ç”¨...' && node server.js"

volumes:
  # å›ºå®šå·åï¼šæ— è®ºä»å“ªä¸ªç›®å½•/é¡¹ç›®åå¯åŠ¨ï¼Œéƒ½ç”¨åŒä¸€å·ï¼Œæ•°æ®ä¸€åŠ³æ°¸é€¸
  postgres_data:
    name: lego_price_king_postgres_data
    driver: local

networks:
  lego_network:
    driver: bridge
