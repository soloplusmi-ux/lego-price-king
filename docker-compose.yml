services:
  # PostgreSQL æ•°æ®åº“
  # å¯†ç ç»Ÿä¸€ç”¨ POSTGRES_PASSWORDï¼›è‹¥éœ€ä¿®æ”¹ï¼Œåœ¨ä¸‹æ–¹æˆ– .env ä¸­æ”¹ä¸€å¤„å³å¯
  postgres:
    image: postgres:15-alpine
    container_name: lego_price_king_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: lego_price_king
    ports:
      # æš´éœ²ç«¯å£ä»¥ä¾¿æœ¬åœ°è„šæœ¬è¿æ¥
      - "5432:5432"
    volumes:
      # æŒä¹…åŒ–æ•°æ®å·
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d lego_price_king"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - lego_network
    restart: unless-stopped

  # Next.js åº”ç”¨
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: lego_price_king_app
    environment:
      # ä¸ postgres æœåŠ¡å…±ç”¨ POSTGRES_PASSWORDï¼Œé»˜è®¤ postgres
      # æ³¨æ„ï¼šå¦‚æœ .env ä¸­è®¾ç½®äº† POSTGRES_PASSWORDï¼Œè¿™é‡Œä¼šè‡ªåŠ¨ä½¿ç”¨ï¼›å¦åˆ™ä½¿ç”¨é»˜è®¤å€¼ postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      DATABASE_URL: "postgresql://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/lego_price_king?schema=public&connection_limit=10&pool_timeout=20&connect_timeout=10"
      NODE_ENV: production
      # ä» .env æ–‡ä»¶è¯»å–å…¶ä»–é…ç½®
    env_file:
      - .env
    ports:
      - "3000:3000"
    volumes:
      # æŒ‚è½½ public/imagesï¼Œä¾¿äºåœ¨æœåŠ¡å™¨ä¸Šç›´æ¥æ”¾ç½®ä»¥ã€Œç¼–å·ã€å‘½åçš„å›¾ç‰‡ï¼ˆå¦‚ 10264-1.jpgï¼‰
      - ./public/images:/app/public/images
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - lego_network
    restart: unless-stopped
    # å¯åŠ¨æ—¶å…ˆç­‰å¾…æ•°æ®åº“å°±ç»ªï¼Œåˆå§‹åŒ–æ•°æ®åº“ï¼Œç”Ÿæˆ Prisma Clientï¼Œç„¶åå¯åŠ¨åº”ç”¨
    command: sh -c "echo 'ç­‰å¾…æ•°æ®åº“å°±ç»ª...' && sleep 5 && cd /app && echo 'æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨...' && PGPASSWORD=$${POSTGRES_PASSWORD:-postgres} psql -h postgres -U postgres -tc \"SELECT 1 FROM pg_database WHERE datname = 'lego_price_king'\" | grep -q 1 || PGPASSWORD=$${POSTGRES_PASSWORD:-postgres} psql -h postgres -U postgres -c \"CREATE DATABASE lego_price_king;\" && echo 'âœ… æ•°æ®åº“ lego_price_king å·²ç¡®è®¤å­˜åœ¨' && npx prisma generate --schema=./prisma/schema.prisma && echo 'âœ… Prisma Client ç”Ÿæˆå®Œæˆ' && npx prisma db push --accept-data-loss --skip-generate && echo 'âœ… æ•°æ®åº“è¡¨ç»“æ„å·²åŒæ­¥' && echo 'ğŸš€ å¯åŠ¨åº”ç”¨...' && node server.js"

volumes:
  postgres_data:
    driver: local

networks:
  lego_network:
    driver: bridge
